<html>

<head>
    <title>SignUp page</title>
    <link rel="stylesheet" type="text/css" href="CSS/signup.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous"> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->
</head>

<body>
    <div class="signupbox">
        <img src="images/3300.jpg" class="car">
        <h1>Sign Up</h1>
        <span id="success" style="color: rgb(122, 211, 32); display: none; text-align: center; font-size: 20px;">*
            Details updated successfully</span>
        <span id="emailexists" style="color: #dc1c1c; display: none; text-align: center; font-size: 20px;">* Email
            address already exists</span>
        <span id="invalidfile" style="color: #dc1c1c; display: none; text-align: center; font-size: 20px;">* Invalid
            file format</span>
        <img src="" id="displayimage"><br>
        <label id="propic">Profile picture :</label>
        <input type="file" id="image">
        <form>
            <input type="text" id="fullname" placeholder="Full name"><br>
            <input type="date" id="dob" onmouseover="myFunction1()" onmouseleave="myFunction2()"
                placeholder="Date of Birth">
            <input type="text" id="age" placeholder="Age" readonly><br>
            <input type="email" id="email" placeholder="Email-Id">
            <input type="text" id="mob" placeholder="Mobile number"><br>
            <input type="text" id="presentaddress" placeholder="Present address"><br>
            <input type="text" id="permanentaddress" placeholder="Permanent address"><br>
            <input type="password" id="password" placeholder="Password"><br>
            <input type="password" id="confirmpassword" placeholder="Confirm password"><br>
            <input type="submit" id="submit" onclick="signupbtnhandler();event.preventDefault();" value="Register">


        </form>
        <hr color="grey">
        <p id="para">Already have an account?</p>
        <button id="loginbttn" onclick="loginbttnhandler();event.preventDefault();">Login</button>
    </div>

    <script>

        var image = document.getElementById("image")
        document.querySelector("input[type=file]").addEventListener("change", function () {
            var img = document.getElementById("displayimage")
            img.src = URL.createObjectURL(this.files[0]);
        });

        //DATE OF BIRTH HOVER
        var birth = document.getElementById("dob");
        var age1 = document.getElementById("age");
        birth.addEventListener("input", function () { age1.value = calcage(birth.value) });

        function myFunction1() {
            var x = document.getElementById("dob");
            x.type = "date";
        }

        function myFunction2() {
            var x = document.getElementById("dob");
            x.type = "text";
        }

        function calcage(dob) {
            var today = new Date();
            var birth = new Date(dob);
            var age = today.getFullYear() - birth.getFullYear();
            var month = today.getMonth() - birth.getMonth();
            var date = today.getDate() - birth.getDate();
            if (month < 0 || (month === 0 && date < 0)) {
                age--;
            }
            return age;
        }

        function signupbtnhandler() {
            var fullname = document.getElementById("fullname").value;
            if (validateName(fullname)) {
                var dob = document.getElementById("dob").value;
                if (validateDob(dob)) {
                    console.log("DOB is verified");
                    var age = document.getElementById("age").value;
                    if (age >= 0) {
                        var email = document.getElementById("email").value;
                        if (validateEmail(email)) {
                            console.log("Email ID is valid");
                            var mob = document.getElementById("mob").value;
                            if (validateMob(mob)) {
                                var presentaddress = document.getElementById("presentaddress").value;
                                if (validateAddress(presentaddress)) {
                                    var permanentaddress = document.getElementById("permanentaddress").value;
                                    if (validateAddress(permanentaddress)) {
                                        var password = document.getElementById("password").value;
                                        var confirmpassword = document.getElementById("confirmpassword").value;
                                        var status = 0;
                                        var role = 4;
                                        var data = {
                                            name: fullname,
                                            dob: dob,
                                            age: age,
                                            email: email,
                                            mob: mob,
                                            presentAddress: presentaddress,
                                            permanentAddress: permanentaddress,
                                            pwd: password,
                                            role: role,
                                            status: status
                                        }
                                        var img = document.getElementById("image");
                                        //var url = URL.createObjectURL(img.files[0]);
                                        //let html = "<img src= '"+url+"' > ";
                                        //document.getElementById("imagedisplay").innerHTML(html);
                                        let formdata = new FormData();
                                        formdata.append("name", fullname);
                                        formdata.append("dob", dob);
                                        formdata.append("age", age);
                                        formdata.append("email", email);
                                        formdata.append("mob", mob);
                                        formdata.append("presentAddress", presentaddress);
                                        formdata.append("permanentAddress", permanentaddress);
                                        formdata.append("pwd", password);
                                        formdata.append("role", role);
                                        formdata.append("status", status);
                                        formdata.append("image", img.files[0]);
                                        console.log(formdata)
                                        var xhr = new XMLHttpRequest();
                                        xhr.open("POST", "http://localhost:8080/employee/register");
                                        //xhr.setRequestHeader("Content-Type", "application/JSON;charset-UTF8");
                                        xhr.onload = function () {
                                            var msg = xhr.responseText;
                                            console.log(msg);
                                            // if(msg!="Failed to register")
                                            if (msg == 0) {
                                                document.getElementById("emailexists").style.display = "block";
                                                document.getElementById("fullname").value = "";
                                                document.getElementById("dob").value = "";
                                                document.getElementById("age").value = "";
                                                document.getElementById("email").value = "";
                                                document.getElementById("mob").value = "";
                                                document.getElementById("presentaddress").value = "";
                                                document.getElementById("permanentaddress").value = "";
                                                document.getElementById("password").value = "";
                                                document.getElementById("confirmpassword").value = "";
                                            }
                                            else if (msg == 99) {
                                                document.getElementById("invalidfile").style.display = "block";
                                            }
                                            else {
                                                
                                                document.getElementById("emailexists").style.display = "none";
                                                document.getElementById("invalidfile").style.display = "none";
                                                document.getElementById("propic").style.display = "none";
                                                document.getElementById("image").style.display = "none";
                                                document.getElementById("displayimage").style.display = "none";
                                                document.getElementById("success").style.display = "block";
                                                document.getElementById("fullname").style.display = "none";
                                                document.getElementById("dob").style.display = "none";
                                                document.getElementById("age").style.display = "none";
                                                document.getElementById("email").style.display = "none";
                                                document.getElementById("mob").style.display = "none";
                                                document.getElementById("presentaddress").style.display = "none";
                                                document.getElementById("permanentaddress").style.display = "none";
                                                document.getElementById("password").style.display = "none";
                                                document.getElementById("confirmpassword").style.display = "none";
                                                document.getElementById("submit").style.display = "none";
                                                document.getElementById("para").style.display = "none";
                                                event.preventDefault();
                                            }

                                        }
                                        xhr.send(formdata);
                                    }
                                    else {
                                        window.alert("invalid address");
                                    }
                                }
                                else {
                                    window.alert("invalid address pattern");
                                }
                            }
                            else {
                                window.alert("invalid mobile number pattern");
                            }
                        }
                        else {
                            window.alert("invalid email ");
                        }
                    }
                    else {
                        window.alert("invalid date of birth");
                    }
                }
                else {
                    window.alert("invalid DOB");
                }
            }
            else {
                window.alert("invalid name");
            }
        }

        function loginbttnhandler() {
            window.location.href = "login.html";
        }

        function validateEmail(email) {
            const pattern = new RegExp('^[a-zA-Z0-9+_.-]+@[a-zA-Z0-9]+[.]+[a-zA-Z]{1,3}$');
            //const pattern = new RegExp('^[a-zA-Z0-9+_.-]{1,64}+[@]{1}+[A-Za-z0-9-]{1,254}+[.]+[A-Za-z]{2,3}$')
            return pattern.test(email);
        }

        function validateMob(mob) {
            const pattern = new RegExp('^([6-9][0-9]{9})$')
            return pattern.test(mob);
        }

        function validateAddress(address) {
            const pattern = new RegExp("^([a-zA-Z0-9\s\,\''\-]{1,240})$");
            return pattern.test(address);
        }

        function validateName(fullname) {
            const pattern = new RegExp("^[a-zA-Z ]+$");
            console.log(pattern.test(fullname))
            return pattern.test(fullname);
        }

        function validateDob(dob) {
            console.log(dob);
            const pattern = new RegExp("^[0-9-]+$");
            console.log(pattern.test(dob));
            if (pattern.test(dob) == false) {
                return false;
            }
            var today = new Date();
            var birth = new Date(dob);
            var res = birth < today;
            return res;
            //return (birth < today ? true : false);
        }

    </script>
</body>

</html>